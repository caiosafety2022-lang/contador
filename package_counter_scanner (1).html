<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Package Counter â€“ Full + Camera Scanner</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const nowISO = () => new Date().toISOString();
    const persistKey = "pkgCounterScannerV1";

    function PackageCounter() {
      const [count, setCount] = useState(0);
      const [packages, setPackages] = useState([]);
      const [scanning, setScanning] = useState(false);
      const [lastScan, setLastScan] = useState("");
      const videoRef = useRef(null);
      const codeReaderRef = useRef(null);
      const lastScanAtRef = useRef(0);

      const inc = (id) => {
        const pkg = { id: id || `#${packages.length + 1}`, ts: nowISO() };
        setPackages((arr) => [pkg, ...arr]);
        setCount((c) => c + 1);
        try { navigator.vibrate && navigator.vibrate(10); } catch {}
      };

      const startScanner = async () => {
        if (scanning) return;
        setScanning(true);
        try {
          const ZX = window.ZXing;
          const codeReader = new ZX.BrowserMultiFormatReader();
          codeReaderRef.current = codeReader;
          const deviceId = (await codeReader.listVideoInputDevices())[0]?.deviceId;
          await codeReader.decodeFromVideoDevice(deviceId, videoRef.current, (result, err) => {
            if (result) {
              const text = result.getText();
              const now = Date.now();
              if (now - lastScanAtRef.current > 800 || text !== lastScan) {
                setLastScan(text);
                lastScanAtRef.current = now;
                inc(text);
              }
            }
          });
        } catch (e) {
          alert('Camera error: ' + (e?.message || e));
          setScanning(false);
        }
      };

      const stopScanner = async () => {
        try { await codeReaderRef.current?.reset(); } catch {}
        const v = videoRef.current;
        if (v && v.srcObject) { v.srcObject.getTracks().forEach(t => t.stop()); v.srcObject = null; }
        setScanning(false);
      };

      return (
        <div className=\"p-4 max-w-2xl mx-auto space-y-4\">
          <h1 className=\"text-2xl font-bold\">Package Counter with Scanner</h1>
          <div className=\"flex gap-2\">
            {!scanning ? <button onClick={startScanner} className=\"bg-green-600 text-white px-4 py-2 rounded\">Start Camera</button>
            : <button onClick={stopScanner} className=\"bg-red-600 text-white px-4 py-2 rounded\">Stop Camera</button>}
          </div>
          {scanning && <video ref={videoRef} className=\"w-full border rounded\" muted playsInline></video>}
          <div>Total: {count}</div>
          <ul className=\"divide-y\">
            {packages.map(p=>(<li key={p.ts}>{p.id} <span className=\"text-xs text-gray-500\">{new Date(p.ts).toLocaleTimeString()}</span></li>))}
          </ul>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<PackageCounter/>);
  </script>
</body>
</html>
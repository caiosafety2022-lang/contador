<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Package Counter – Scanner</title>
  <!-- React + ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Babel to run JSX directly in the browser -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- ZXing for barcode/QR scanning -->
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const persistKey = "pkgCounterScannerV2";
    const nowISO = () => new Date().toISOString();

    function App() {
      const [sessionName, setSessionName] = useState("");
      const [sender, setSender] = useState("");
      const [packages, setPackages] = useState([]);
      const [count, setCount] = useState(0);
      const [scanning, setScanning] = useState(false);
      const [lastScan, setLastScan] = useState("");
      const [autoAdd, setAutoAdd] = useState(true);
      const [note, setNote] = useState("");
      const videoRef = useRef(null);
      const idRef = useRef(null);
      const codeReaderRef = useRef(null);
      const lastScanAtRef = useRef(0);

      // Load state
      useEffect(() => {
        try {
          const raw = localStorage.getItem(persistKey);
          if (raw) {
            const s = JSON.parse(raw);
            setSessionName(s.sessionName || "");
            setSender(s.sender || "");
            setPackages(s.packages || []);
            setCount(s.count || 0);
          }
        } catch {}
      }, []);

      // Save state
      useEffect(() => {
        const s = { sessionName, sender, packages, count };
        try { localStorage.setItem(persistKey, JSON.stringify(s)); } catch {}
      }, [sessionName, sender, packages, count]);

      // Beep sound
      const beep = () => {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = "sine"; o.frequency.value = 880;
          o.connect(g); g.connect(ctx.destination);
          g.gain.setValueAtTime(0.0001, ctx.currentTime);
          g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
          o.start();
          setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.04); o.stop(ctx.currentTime + 0.06); }, 60);
        } catch {}
      };

      const inc = (id, note="") => {
        const pkg = { id: id || "#" + (packages.length + 1), note, sender: sender || "-", ts: nowISO() };
        setPackages(arr => [pkg, ...arr]);
        setCount(c => c + 1);
        try { navigator.vibrate && navigator.vibrate(10); } catch {}
        beep();
      };

      const dec = () => {
        setPackages(arr => arr.slice(1));
        setCount(c => Math.max(0, c - 1));
      };

      const reset = () => {
        if (confirm("Reset session? This clears the counter and list.")) {
          setPackages([]);
          setCount(0);
        }
      };

      const onAddManual = () => {
        const id = idRef.current?.value?.trim();
        if (!id) return;
        inc(id, note);
        idRef.current.value = "";
        setNote("");
      };

      const startScan = async () => {
        if (scanning) return;
        setScanning(true);
        try {
          const ZX = window.ZXing;
          const codeReader = new ZX.BrowserMultiFormatReader();
          codeReaderRef.current = codeReader;
          const deviceId = (await codeReader.listVideoInputDevices())[0]?.deviceId;
          await codeReader.decodeFromVideoDevice(deviceId, videoRef.current, (result, err) => {
            if (result) {
              const text = result.getText();
              const now = Date.now();
              // debounce identical scans
              if (now - lastScanAtRef.current > 600 || text !== lastScan) {
                setLastScan(text);
                lastScanAtRef.current = now;
                if (autoAdd) {
                  inc(text);
                } else {
                  if (idRef.current) idRef.current.value = text;
                }
              }
            }
          });
        } catch (e) {
          alert("Camera error: " + (e?.message || e));
          setScanning(false);
        }
      };

      const stopScan = async () => {
        try { await codeReaderRef.current?.reset(); } catch {}
        const v = videoRef.current;
        if (v && v.srcObject) { try { v.srcObject.getTracks().forEach(t => t.stop()); } catch {} v.srcObject = null; }
        setScanning(false);
      };

      useEffect(() => () => { stopScan(); }, []);

      const exportCSV = () => {
        const headers = ["session","sender","index","package_id","note","timestamp_iso"];
        const rows = packages.slice().reverse().map((p,i)=>[sessionName, sender, i+1, p.id, p.note, p.ts]);
        const csv = [headers.join(","), ...rows.map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(","))].join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "packages.csv"; a.click();
        URL.revokeObjectURL(url);
      };

      return (
        <div className="p-4 max-w-4xl mx-auto grid gap-4">
          <h1 className="text-2xl font-bold">Package Counter – Scanner</h1>

          <div className="bg-white p-4 rounded shadow grid gap-2">
            <label className="text-sm">Session</label>
            <input className="border p-2" value={sessionName} onChange={e=>setSessionName(e.target.value)} placeholder="Route/Dock/Shift" />
            <label className="text-sm">Sender</label>
            <input className="border p-2" value={sender} onChange={e=>setSender(e.target.value)} placeholder="Warehouse name" />
          </div>

          <div className="bg-white p-4 rounded shadow grid grid-cols-2 gap-2">
            <button onClick={dec} className="bg-gray-200 p-4 text-xl rounded">-1</button>
            <button onClick={()=>inc()} className="bg-blue-600 text-white p-4 text-xl rounded">+1</button>
            <button onClick={reset} className="bg-red-500 text-white p-3 rounded col-span-2">Reset</button>
          </div>

          <div className="flex justify-between items-center">
            <div>Total: <span className="font-bold">{count}</span></div>
            <div>Sender: {sender || "–"}</div>
          </div>

          <div className="bg-white p-4 rounded shadow grid gap-2">
            <div className="grid md:grid-cols-3 gap-2">
              <input ref={idRef} placeholder="Scan or type package ID" className="border p-2" onKeyDown={(e)=>{ if(e.key==='Enter') onAddManual(); }} />
              <input value={note} onChange={e=>setNote(e.target.value)} placeholder="Notes (optional)" className="border p-2 md:col-span-2" />
            </div>
            <div className="flex gap-2 items-center">
              {!scanning ? (
                <button onClick={startScan} className="bg-emerald-500 text-white px-4 py-2 rounded">Start camera scan</button>
              ) : (
                <button onClick={stopScan} className="bg-gray-700 text-white px-4 py-2 rounded">Stop camera</button>
              )}
              <label className="flex items-center gap-2 text-sm ml-auto">
                <input type="checkbox" checked={autoAdd} onChange={e=>setAutoAdd(e.target.checked)} />
                Auto +1 on every scan
              </label>
            </div>
            {scanning && (
              <div className="mt-3 grid gap-2">
                <video ref={videoRef} className="w-full rounded border" muted playsInline></video>
                <div className="text-xs text-gray-600">Last scan: <span className="font-mono">{lastScan || "—"}</span></div>
              </div>
            )}
          </div>

          <div className="bg-white p-4 rounded shadow">
            <div className="flex justify-between mb-2">
              <h2 className="font-bold">Packages ({packages.length})</h2>
              <button onClick={exportCSV} className="bg-gray-200 px-3 py-1 rounded">Export CSV</button>
            </div>
            {packages.length === 0 ? <p className="text-sm text-gray-500">No packages yet</p> : (
              <ul className="divide-y">
                {packages.map(p => (
                  <li key={p.ts} className="py-1 text-sm">
                    <span className="font-medium">{p.id}</span> – {p.note} <span className="text-gray-400">[{new Date(p.ts).toLocaleString()}]</span>
                  </li>
                ))}
              </ul>
            )}
          </div>

          <p className="text-xs text-center text-gray-400">Works offline • Camera requires HTTPS or localhost</p>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
